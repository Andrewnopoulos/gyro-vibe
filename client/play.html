<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Gyro-Vibe - Play Now</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #121212;
      color: white;
      overflow: hidden;
    }
    .container {
      max-width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      padding: 15px;
      background-color: #1a1a1a;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      text-align: center;
    }
    h1 {
      margin: 0;
      font-size: 1.5rem;
      color: #17a2b8;
    }
    .game-area {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .info-text {
      margin: 20px;
      text-align: center;
      color: #cccccc;
      font-size: 0.9rem;
      max-width: 300px;
    }
    .canvas-container {
      width: 100%;
      flex-grow: 1;
      display: none; /* Initially hidden */
      position: relative;
    }
    #gameCanvas {
      width: 100%;
      height: 100%;
      background-color: #000;
    }
    .game-controls {
      position: absolute;
      bottom: 20px;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 15px;
    }
    .control-button {
      background-color: rgba(23, 162, 184, 0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .back-button {
      position: absolute;
      top: 15px;
      left: 15px;
      background-color: rgba(0,0,0,0.5);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      font-size: 0.9rem;
    }
    
    /* Multiplayer Lobby Styles */
    .lobby-container {
      width: 90%;
      max-width: 500px;
      background-color: rgba(0, 0, 0, 0.9);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      color: white;
    }
    .lobby-title {
      margin: 0 0 20px 0;
      font-size: 24px;
      color: #4fc3f7;
      text-align: center;
    }
    .username-section {
      margin-bottom: 20px;
      text-align: left;
    }
    .username-label {
      display: block;
      margin-bottom: 5px;
    }
    .username-input {
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
      border: 1px solid #555;
      border-radius: 4px;
      background-color: rgba(30, 30, 30, 0.9);
      color: white;
      margin-bottom: 10px;
    }
    .join-section {
      margin-bottom: 20px;
      text-align: left;
    }
    .join-by-code {
      margin-bottom: 20px;
      padding: 15px;
      background-color: rgba(80, 50, 100, 0.4);
      border-radius: 8px;
    }
    .section-title {
      margin: 0 0 10px 0;
      font-size: 18px;
    }
    .code-input-container {
      display: flex;
      gap: 10px;
    }
    .room-code-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #555;
      border-radius: 4px;
      background-color: rgba(30, 30, 30, 0.9);
      color: white;
    }
    .join-button {
      padding: 8px 15px;
      background-color: #17a2b8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .available-rooms {
      padding: 15px;
      background-color: rgba(50, 80, 50, 0.4);
      border-radius: 8px;
    }
    .refresh-button {
      padding: 5px 10px;
      background-color: #444;
      color: white;
      border: none;
      border-radius: 4px;
      margin-bottom: 10px;
      cursor: pointer;
    }
    .rooms-list {
      max-height: 200px;
      overflow-y: auto;
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
      padding: 5px;
      margin-top: 5px;
    }
    .no-rooms-message {
      padding: 10px;
      text-align: center;
      color: #888;
      font-style: italic;
    }
    .room-item {
      padding: 10px;
      margin-bottom: 5px;
      background-color: rgba(50, 50, 80, 0.4);
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .room-item:hover {
      background-color: rgba(70, 70, 120, 0.6);
    }
    .room-name {
      font-weight: bold;
    }
    .room-info {
      font-size: 12px;
      margin-top: 3px;
    }
    .room-code {
      float: right;
      font-family: monospace;
      color: #aaf;
    }
    .status-message {
      margin-top: 10px;
      color: #ff5555;
      min-height: 20px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Gyro-Vibe Multiplayer</h1>
    </div>
    
    <div class="game-area" id="lobbyScreen">
      <div class="lobby-container">
        <h1 class="lobby-title">Join a Game</h1>
        
        <!-- Username input section -->
        <div class="username-section">
          <label class="username-label">Your Username:</label>
          <input id="username-input" type="text" placeholder="Enter your username" class="username-input">
        </div>
        
        <div class="join-section">
          <!-- Join by code section -->
          <div class="join-by-code">
            <h2 class="section-title">Join with Room Code</h2>
            <label>Room Code:</label>
            <div class="code-input-container">
              <input id="room-code-input" type="text" placeholder="Enter room code" class="room-code-input">
              <button id="join-room-btn" class="join-button">Join</button>
            </div>
          </div>
          
          <!-- Available rooms section -->
          <div class="available-rooms">
            <h2 class="section-title">Available Rooms</h2>
            <button id="refresh-rooms-btn" class="refresh-button">Refresh List</button>
            <div id="rooms-list" class="rooms-list">
              <div id="no-rooms-message" class="no-rooms-message">No rooms available. Refresh the list.</div>
            </div>
          </div>
        </div>
        
        <!-- Status message area -->
        <div id="lobby-status-message" class="status-message"></div>
      </div>
    </div>
    
    <div class="canvas-container" id="gameScreen">
      <canvas id="gameCanvas"></canvas>
      <button id="backBtn" class="back-button">Back</button>
      <div class="game-controls">
        <button class="control-button">A</button>
        <button class="control-button">B</button>
      </div>
    </div>
  </div>
  
  <script src="/socket.io/socket.io.js"></script>
  <script type="module">
    import { EventBus } from './js/utils/event-bus.js';
    import { SocketManager } from './js/communication/socket-manager.js';
    import { GameStateManager } from './js/game/game-state-manager.js';
    
    // DOM elements
    const lobbyScreen = document.getElementById('lobbyScreen');
    const gameScreen = document.getElementById('gameScreen');
    const gameCanvas = document.getElementById('gameCanvas');
    const usernameInput = document.getElementById('username-input');
    const roomCodeInput = document.getElementById('room-code-input');
    const joinRoomBtn = document.getElementById('join-room-btn');
    const refreshRoomsBtn = document.getElementById('refresh-rooms-btn');
    const roomsList = document.getElementById('rooms-list');
    const noRoomsMessage = document.getElementById('no-rooms-message');
    const lobbyStatusMessage = document.getElementById('lobby-status-message');
    const backBtn = document.getElementById('backBtn');
    
    // Set up canvas context and resize handling
    const ctx = gameCanvas.getContext('2d');
    
    function resizeCanvas() {
      const container = gameCanvas.parentElement;
      gameCanvas.width = container.clientWidth;
      gameCanvas.height = container.clientHeight;
      // Redraw canvas if needed
      if (gameScreen.style.display === 'block') {
        drawGameScreen();
      }
    }
    
    window.addEventListener('resize', resizeCanvas);
    
    // Simple game state
    const gameState = {
      mode: 'multiplayer',
      active: false,
      orientation: {
        alpha: 0,
        beta: 0,
        gamma: 0
      },
      acceleration: {
        x: 0,
        y: 0,
        z: 0
      }
    };
    
    // Draw the game screen
    function drawGameScreen() {
      ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
      
      // Fill background
      ctx.fillStyle = '#121212';
      ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
      
      // Draw game mode text
      ctx.fillStyle = '#ffffff';
      ctx.font = '18px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('Multiplayer Mode', gameCanvas.width / 2, 30);
      
      // Draw orientation data if available
      if (gameState.active) {
        // Center point
        const centerX = gameCanvas.width / 2;
        const centerY = gameCanvas.height / 2;
        
        // Draw a crosshair
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(centerX - 50, centerY);
        ctx.lineTo(centerX + 50, centerY);
        ctx.moveTo(centerX, centerY - 50);
        ctx.lineTo(centerX, centerY + 50);
        ctx.stroke();
        
        // Draw orientation indicator
        const radius = 100;
        const posX = centerX + (gameState.orientation.gamma / 90) * radius;
        const posY = centerY + (gameState.orientation.beta / 90) * radius;
        
        ctx.beginPath();
        ctx.arc(posX, posY, 20, 0, Math.PI * 2);
        ctx.fillStyle = '#17a2b8';
        ctx.fill();
        
        // Display orientation values
        ctx.fillStyle = '#ffffff';
        ctx.font = '14px Arial';
        ctx.textAlign = 'left';
        ctx.fillText(`Alpha: ${gameState.orientation.alpha.toFixed(1)}°`, 20, gameCanvas.height - 80);
        ctx.fillText(`Beta: ${gameState.orientation.beta.toFixed(1)}°`, 20, gameCanvas.height - 60);
        ctx.fillText(`Gamma: ${gameState.orientation.gamma.toFixed(1)}°`, 20, gameCanvas.height - 40);
      } else {
        // Show a message to tilt the device
        ctx.fillStyle = '#ffffff';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Tilt your device to play', centerX, centerY - 20);
        ctx.fillText('Allow sensor access when prompted', centerX, centerY + 20);
      }
    }
    
    class SimpleLobbyManager {
      constructor() {
        this.eventBus = new EventBus();
        this.socketManager = new SocketManager(this.eventBus);
        this.gameStateManager = new GameStateManager(this.eventBus, this.socketManager);
        this.availableRooms = [];
        this.setupEventListeners();
        
        // Automatically request session creation
        this.socketManager.emit('create-session');
        
        // Request available rooms when initialized
        setTimeout(() => {
          this.refreshRoomsList();
        }, 1000);
      }
      
      setupEventListeners() {
        // Multiplayer events
        this.eventBus.on('multiplayer:rooms-list', this.handleRoomsList.bind(this));
        this.eventBus.on('multiplayer:room-joined', this.handleRoomJoined.bind(this));
        this.eventBus.on('multiplayer:room-left', this.handleRoomLeft.bind(this));
        this.eventBus.on('multiplayer:room-error', this.handleRoomError.bind(this));
        
        // UI event listeners
        joinRoomBtn.addEventListener('click', () => this.handleJoinRoom());
        refreshRoomsBtn.addEventListener('click', () => this.refreshRoomsList());
        backBtn.addEventListener('click', () => this.handleLeaveRoom());
        
      }
      
      handleRoomsList(data) {
        this.availableRooms = data.rooms || [];
        this.updateRoomsList();
      }
      
      updateRoomsList() {
        // Clear existing content
        roomsList.innerHTML = '';
        
        if (this.availableRooms.length === 0) {
          roomsList.appendChild(noRoomsMessage);
          return;
        }
        
        // Add rooms to list
        this.availableRooms.forEach(room => {
          const roomItem = document.createElement('div');
          roomItem.className = 'room-item';
          
          roomItem.innerHTML = `
            <div class="room-name">${room.roomName}</div>
            <div class="room-info">
              <span>Players: ${room.playerCount}/${room.maxPlayers}</span>
              <span class="room-code">Code: ${room.roomCode}</span>
            </div>
          `;
          
          roomItem.onclick = () => {
            const username = usernameInput.value.trim() || 'Player' + Math.floor(Math.random() * 1000);
            usernameInput.value = username;
            this.gameStateManager.joinRoom(room.roomCode, username);
          };
          
          roomsList.appendChild(roomItem);
        });
      }
      
      handleJoinRoom() {
        const username = usernameInput.value.trim();
        const roomCode = roomCodeInput.value.trim();
        
        if (!username) {
          this.showLobbyError('Please enter a username');
          return;
        }
        
        if (!roomCode) {
          this.showLobbyError('Please enter a room code');
          return;
        }
        
        this.gameStateManager.joinRoom(roomCode, username);
      }
      
      handleLeaveRoom() {
        this.gameStateManager.leaveRoom();
        
        // Return to menu
        gameScreen.style.display = 'none';
        lobbyScreen.style.display = 'flex';
        
        // Stop the game
        gameState.active = false;
      }
      
      refreshRoomsList() {
        this.gameStateManager.listRooms();
      }
      
      handleRoomJoined(data) {
        lobbyScreen.style.display = 'none';
        gameScreen.style.display = 'block';
        resizeCanvas();
        
        // Start sensor access
        enableSensors();
        
        // Set up the animation loop
        requestAnimationFrame(gameLoop);
      }
      
      handleRoomLeft() {
        // Return to lobby
        gameScreen.style.display = 'none';
        lobbyScreen.style.display = 'flex';
      }
      
      handleRoomError(data) {
        this.showLobbyError(data.error);
      }
      
      showLobbyError(message) {
        lobbyStatusMessage.textContent = message;
        lobbyStatusMessage.style.display = 'block';
        
        // Hide after 5 seconds
        setTimeout(() => {
          lobbyStatusMessage.style.display = 'none';
        }, 5000);
      }
    }
    
    // Game loop
    function gameLoop() {
      drawGameScreen();
      requestAnimationFrame(gameLoop);
    }
    
    // Enable device sensors
    async function enableSensors() {
      // Request permission on iOS
      if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        try {
          const permission = await DeviceOrientationEvent.requestPermission();
          if (permission === 'granted') {
            setupSensors();
          } else {
            console.log('Permission denied for orientation sensors');
          }
        } catch (err) {
          console.error('Error requesting orientation permission:', err);
        }
      } else {
        // Non-iOS devices
        setupSensors();
      }
    }
    
    // Set up sensor event listeners
    function setupSensors() {
      // Orientation sensor
      window.addEventListener('deviceorientation', (event) => {
        gameState.orientation.alpha = event.alpha || 0;
        gameState.orientation.beta = event.beta || 0;
        gameState.orientation.gamma = event.gamma || 0;
        
        // Mark game as active once we receive sensor data
        if (!gameState.active) {
          gameState.active = true;
        }
      });
      
      // Motion sensor
      window.addEventListener('devicemotion', (event) => {
        if (event.accelerationIncludingGravity) {
          gameState.acceleration.x = event.accelerationIncludingGravity.x || 0;
          gameState.acceleration.y = event.accelerationIncludingGravity.y || 0;
          gameState.acceleration.z = event.accelerationIncludingGravity.z || 0;
        }
      });
    }
    
    // Initialize the application when the DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize the simple lobby manager
      window.lobbyManager = new SimpleLobbyManager();
    });
  </script>
</body>
</html>